source:
  connection_key: HSTG
  object_schema: dbo
  object_name: HSTG_MIDAS_SALE_PREMIUM_COMPONENT_MIDAS_FN
  key_columns:
    - column_name: SALE_PREMIUM_ID
      data_type: int
      max_length: 4
    - column_name: OMD_INSERT_DATETIME
      data_type: datetime2(7)
    - column_name: OMD_ROW_NUMBER
      data_type: int
      max_length: 4
target:
  connection_key: INT
  object_schema: dbo
  object_name: HUB_SALE_PREMIUM
  key_columns:
    - column_name: SALE_PREMIUM_SK
      data_type: nvarchar
      max_length: 200
    - column_name: OMD_FIRST_SEEN_DATETIME
      data_type: datetime2(7)
mapped_columns:
  - source:
      column_name: OMD_HASH_HUB_SALE_PREMIUM
      data_type: char
      max_length: 32
    target:
      column_name: SALE_PREMIUM_SK
      data_type: char
      max_length: 32
  - source:
      column_name: OMD_INSERT_DATETIME
      data_type: datetime2(7)
    target:
      column_name: OMD_FIRST_SEEN_DATETIME
      data_type: datetime2(7)
  - source:
      column_name: SALE_PREMIUM_ID
      data_type: nvarchar
      max_length: 200
    target:
      column_name: SALE_PREMIUM_ID
      data_type: nvarchar
      max_length: 200
ignore_on_refresh:
  - source:
      column_name: OMD_RECORD_SOURCE
      data_type: varchar
      max_length: 100
  - target:
      column_name: OMD_RECORD_SOURCE_ID
      data_type: int
  - target:
      column_name: OMD_INSERT_MODULE_INSTANCE_ID
extension:
  - AP_AU_DV:
      source_sql: |
        declare	@INTERVAL_START_DATETIME datetime2(7) = EDW_900_OMD_Framework.dbo.GetLoadWindowDateTimes('m_200_HUB_SALE_PREMIUM_MIDAS_SALE_PREMIUM_COMPONENT_MIDAS_VW', 1),
            @INTERVAL_END_DATETIME datetime2(7) = EDW_900_OMD_Framework.dbo.GetLoadWindowDateTimes('m_200_HUB_SALE_PREMIUM_MIDAS_SALE_PREMIUM_COMPONENT_MIDAS_VW', 2);

        SELECT HUB_outer_selection.*
        FROM    (
                SELECT CONVERT(CHAR(32), HASHBYTES('MD5',
                                        ISNULL(RTRIM(CONVERT(NVARCHAR(100), SALE_PREMIUM_ID)), 'NA')+'|'
                              ),2) AS OMD_HASH_HUB_SALE_PREMIUM,
                    SALE_PREMIUM_ID,
                    OMD_RECORD_SOURCE,
                    OMD_INSERT_DATETIME
                FROM    (
                        SELECT CAST(main.SALE_PREMIUM_ID AS NVARCHAR(100)) AS SALE_PREMIUM_ID,
                            OMD_RECORD_SOURCE,
                            MIN(OMD_INSERT_DATETIME) AS OMD_INSERT_DATETIME
                        FROM HSTG_MIDAS_SALE_PREMIUM_COMPONENT_MIDAS_FN(@INTERVAL_START_DATETIME, @INTERVAL_END_DATETIME) main
                        WHERE main.SALE_PREMIUM_ID IS NOT NULL
                        GROUP BY main.SALE_PREMIUM_ID,
                            OMD_RECORD_SOURCE
                        ) HUB_inner_selection
                ) HUB_outer_selection
            LEFT JOIN EDW_200_Integration_Layer.dbo.HUB_SALE_PREMIUM HUB_target
                ON HUB_outer_selection.OMD_HASH_HUB_SALE_PREMIUM = HUB_target.SALE_PREMIUM_SK
        WHERE HUB_target.SALE_PREMIUM_SK IS NULL;
